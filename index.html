<!DOCTYPE html>
<html lang="en-us">

<head>
  <title>Cloud Clipboard</title>
  <style>
    body {
      font-family: sans-serif;
      background: #0f0b0a;
      color: beige;
      padding: 1em;
    }

    input {
      background: #373433;
      color: beige;
      height: 2.5em;
    }

    textarea {
      background: #373433;
      color: beige;
      height: 5em;
      font-family: monospace;
    }

    button {
      background: #373433;
      color: beige;
      display: inline-block;
    }

    #controlPanel {
      margin-bottom: 2em;
    }

    #clipboardName {
      width: 25em;
      margin-bottom: 1em;
    }

    #connectionStatus {
      color: gray;
      font-size: small;
      display: inline-block;
      vertical-align: bottom;
    }

    #clipboardContent {
      width: 25em;
      margin-bottom: 1em;
    }

    #history {
      font-size: small;
      font-family: monospace;
      width: 50%;
    }

    #history p {
      padding: .5em;
      white-space: pre-wrap;
      border-bottom: #3c3838 dotted 1px;
    }

    #history p:hover {
      background: #373433;
    }
  </style>
  <script>
    let model = {
      clipboardName: null,
      randomButton: null,
      connectButton: null,
      connectionStatus: null,
      clipboardContent: null,
      history: null,

      ws: null,
    };

    function disconnect() {
      // Close previously opened socket.
      if (model.ws !== null) {
        model.ws.close();
        model.ws = null;
      }

      model.connectionStatus.innerText = "Disconnected";
      model.history.innerHTML = "";
    }

    async function setClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        console.log("Copied to clipboard: " + text);
      } catch (error) {
        console.error(error.message);
      }
    }

    async function handleMessage(message) {
      let item = document.createElement("p");
      item.innerText = message;
      item.addEventListener("click", async () => setClipboard(message));

      model.history.insertBefore(item, model.history.firstChild);
      setClipboard(message);
    }

    async function connectClipboard() {
      disconnect();

      if (model.clipboardName.value === "") {
        alert("Clipboard name can't be empty.");
        return;
      }

      model.connectionStatus.innerText = "Connecting...";

      let res = await fetch(`${window.location.origin}/api/negotiate?name=${model.clipboardName.value}`);
      let url = await res.json();

      model.ws = new WebSocket(url.url);

      model.ws.onopen = () => {
        console.log("Connected");
        model.connectionStatus.innerText = "Connected";
      };

      model.ws.onclose = () => {
        console.log("Disconnected");
        model.connectionStatus.innerText = "Disconnected";
      };

      model.ws.onerror = (error) => {
        console.error("Socket Error:", error);
        model.connectionStatus.innerText = "Failed";
      };

      model.ws.onmessage = async (event) => {
        await handleMessage(event.data);
      };
    }

    async function randomizeName() {
      disconnect();

      let res = await fetch(`${window.location.origin}/api/random`);
      let result = await res.json();
      model.clipboardName.value = result.name;
    }

    async function attachUI() {
      model.clipboardName = document.querySelector("#clipboardName");
      model.randomButton = document.querySelector("#randomButton");
      model.connectButton = document.querySelector("#connectButton");
      model.connectionStatus = document.querySelector("#connectionStatus");
      model.clipboardContent = document.querySelector("#clipboardContent");
      model.history = document.querySelector("#history");

      model.connectButton.addEventListener("click", async () => connectClipboard());
      model.randomButton.addEventListener("click", async () => randomizeName());

      model.clipboardContent.addEventListener("keypress", (e) => {
        if (e.charCode !== 13) return;

        if (model.ws !== null) {
          model.ws.send(model.clipboardContent.value);
          model.clipboardContent.value = "";
          e.preventDefault();
        }
      })

      await randomizeName();
    }
  </script>
</head>

<body>
  <h1>Cloud Clipboard</h1>
  <div id="controlPanel">
    <div>Clipboard Name</div>
    <div><input id="clipboardName" placeholder="Enter a unique clipboard name..." /></div>
    <div id="controlPanelButtons">
      <button id="randomButton">Random</button>
      <button id="connectButton">Connect</button>
      <div id="connectionStatus">Disconnected</div>
    </div>
  </div>
  <div id="clipboardPanel">
    <div>Clipboard</div>
    <div><textarea id="clipboardContent" placeholder="Paste and press Enter..."></textarea></div>
    <div>History</div>
    <div id="history"></div>
  </div>
  <script>(async () => { attachUI(); })();</script>
</body>

</html>